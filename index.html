<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Monitoring IKT & PPS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container py-3">

  <!-- HEADER -->
  <div class="alfa-topbar mb-3">
    <div class="d-flex align-items-center gap-3 mb-2">
      <img src="alfamart-logo.png" style="height:36px;background:#fff;border-radius:8px;padding:4px;">
      <div>
        <div class="alfa-title">Dashboard Monitoring IKT & PPS</div>
        <div class="small opacity-75">SAT TAJURHALANG | BI33</div>
      </div>
    </div>

    <select id="monthSelect" class="form-select mb-2" onchange="loadDashboard()"></select>

    <div class="d-flex gap-2 action-bar">
      <a href="settings.html" class="btn btn-light btn-settings">âš™</a>
      <a href="input.html" class="btn btn-primary btn-input">+ Input Harian</a>
    </div>
  </div>

  <!-- KPI -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card"><div class="card-body">
        <div class="text-muted small">Net Sales Ach%</div>
        <div class="fs-3 fw-bold" id="cardSalesAch">-</div>
        <div class="small">Target: <b id="cardSalesTarget">-</b><br>Actual: <b id="cardSalesActual">-</b></div>
        <div class="progress mt-2"><div class="progress-bar" id="barSales"></div></div>
      </div></div>
    </div>

    <div class="col-md-3">
      <div class="card"><div class="card-body">
        <div class="text-muted small">APC AVG Ach%</div>
        <div class="fs-3 fw-bold" id="cardApcAch">-</div>
        <div class="small">Target: <b id="cardApcTarget">-</b><br>Avg: <b id="cardApcActual">-</b></div>
        <div class="progress mt-2"><div class="progress-bar" id="barApc"></div></div>
      </div></div>
    </div>

    <div class="col-md-3">
      <div class="card"><div class="card-body">
        <div class="text-muted small">PPS Score</div>
        <div class="d-flex justify-content-between">
          <div class="fs-3 fw-bold" id="cardPpsScore">-</div>
          <span class="badge" id="cardPpsStatus">-</span>
        </div>
        <div class="progress mt-2"><div class="progress-bar" id="barPps"></div></div>
      </div></div>
    </div>

    <div class="col-md-3">
      <div class="card"><div class="card-body small">
        <div class="text-muted">GAP to Target</div>
        Net Sales: <b id="gapSales">-</b><br>
        PSM: <b id="gapPsm">-</b><br>
        PWP: <b id="gapPwp">-</b><br>
        SG: <b id="gapSg">-</b>
      </div></div>
    </div>
  </div>

  <!-- TRACKER -->
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card"><div class="card-body">
        <div class="fw-semibold mb-2">PSM (4 WEEK)</div>
        <div id="psmTracker" class="d-grid gap-2"></div>
      </div></div>
    </div>

    <div class="col-md-6">
      <div class="card mb-3"><div class="card-body">
        <div class="fw-semibold mb-2">PWP (2 WEEK)</div>
        <div id="pwpTracker" class="d-grid gap-2"></div>
      </div></div>

      <div class="card"><div class="card-body">
        <div class="fw-semibold mb-2">SERBA GRATIS (2 WEEK)</div>
        <div id="sgTracker" class="d-grid gap-2"></div>
      </div></div>
    </div>
  </div>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyDwAQ1huvii-IJC6LT17CzH-Q6AawGgpOw",
  authDomain:"numeric-nova-471404-c0.firebaseapp.com",
  projectId:"numeric-nova-471404-c0"
});
const db=firebase.firestore();

/* ===== HELPERS ===== */
const num=v=>Number(v||0);
const rupiah=n=>new Intl.NumberFormat("id-ID").format(Math.round(n||0));
const pct=x=>(x*100).toFixed(1)+"%";
const clamp=x=>Math.max(0,Math.min(1,x));

function status(a){
  if(a>=1) return {t:"ON TRACK",c:"bg-success"};
  if(a>=0.9) return {t:"WARNING",c:"bg-warning text-dark"};
  return {t:"DANGER",c:"bg-danger"};
}

function setBar(id,a){
  const el=document.getElementById(id);
  el.style.width=Math.min(a*100,150)+"%";
  el.className="progress-bar "+status(a).c;
}

function renderTracker(id,items){
  const el=document.getElementById(id);
  el.innerHTML="";
  items.forEach(it=>{
    const ach=it.target?it.actual/it.target:0;
    el.innerHTML+=`
      <div>
        <div class="d-flex justify-content-between small">
          <div>${it.label} ${it.range}</div>
          <div>${it.actual}/${it.target} <span class="badge ${status(ach).c}">${pct(ach)}</span></div>
        </div>
        <div class="progress"><div class="progress-bar ${status(ach).c}" style="width:${Math.min(ach*100,150)}%"></div></div>
      </div>`;
  });
}

/* ===== MONTH ===== */
function currentMonth(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}

async function loadMonthList(){
  const sel=document.getElementById("monthSelect");
  sel.innerHTML="";
  const snap=await db.collection("config").orderBy("month","desc").get();
  const months=snap.docs.map(d=>d.id);
  (months.length?months:[currentMonth()]).forEach(m=>{
    const o=document.createElement("option");
    o.value=m;o.textContent=m;sel.appendChild(o);
  });
  sel.value=months.includes(currentMonth())?currentMonth():months[0];
}

/* ===== DASHBOARD ===== */
async function loadDashboard(){
  const month=monthSelect.value;
  const cfg=(await db.collection("config").doc(month).get()).data();
  if(!cfg) return;

  const sales=(await db.collection("daily_sales").get()).docs.map(d=>d.data()).filter(r=>r.date.startsWith(month));
  const pps=(await db.collection("pps_daily").get()).docs.map(d=>d.data()).filter(r=>r.date.startsWith(month));

  const actualSales=sales.reduce((a,r)=>a+num(r.netSales),0);
  const salesAch=cfg.targetNetSales?actualSales/cfg.targetNetSales:0;

  cardSalesTarget.textContent=rupiah(cfg.targetNetSales);
  cardSalesActual.textContent=rupiah(actualSales);
  cardSalesAch.textContent=pct(salesAch);
  setBar("barSales",salesAch);

  const apcAvg=pps.reduce((a,r)=>a+num(r.APC),0)/(pps.length||1);
  const apcAch=cfg.targetAPC?apcAvg/cfg.targetAPC:0;

  cardApcTarget.textContent=rupiah(cfg.targetAPC);
  cardApcActual.textContent=rupiah(apcAvg);
  cardApcAch.textContent=pct(apcAch);
  setBar("barApc",apcAch);

  const score=clamp(apcAch);
  cardPpsScore.textContent=pct(score);
  const st=status(score);
  cardPpsStatus.textContent=st.t;
  cardPpsStatus.className="badge "+st.c;
  setBar("barPps",score);
}

(async()=>{
  await loadMonthList();
  await loadDashboard();
})();
</script>

</body>
</html>
