<script>
async function loadDashboard(){
  const month = document.getElementById("monthSelect").value;
  if(!month) return;

  const cfgSnap = await db.collection("config").doc(month).get();
  if(!cfgSnap.exists) return;

  const cfg = cfgSnap.data();
  const [Y,M] = month.split("-").map(Number);
  const eom = new Date(Y,M,0).getDate();

  const salesSnap = await db.collection("daily_sales").orderBy("date").get();
  const ppsSnap   = await db.collection("pps_daily").orderBy("date").get();

  const sales = salesSnap.docs.map(d=>d.data()).filter(r=>r.date.startsWith(month));
  const pps   = ppsSnap.docs.map(d=>d.data()).filter(r=>r.date.startsWith(month));

  /* ===== SALES ===== */
  const actualSales = sales.reduce((a,r)=>a+num(r.netSales),0);
  const salesAch = cfg.targetNetSales ? actualSales/cfg.targetNetSales : 0;

  cardSalesTarget.textContent = rupiah(cfg.targetNetSales);
  cardSalesActual.textContent = rupiah(actualSales);
  cardSalesAch.textContent    = pct(salesAch);
  setBar("barSales", salesAch);

  /* ===== APC ===== */
  const apcAvg = pps.reduce((a,r)=>a+num(r.APC),0) / (pps.length||1);
  const apcAch = cfg.targetAPC ? apcAvg/cfg.targetAPC : 0;

  cardApcTarget.textContent = rupiah(cfg.targetAPC);
  cardApcActual.textContent = rupiah(apcAvg);
  cardApcAch.textContent    = pct(apcAch);
  setBar("barApc", apcAch);

  /* ===== HELPER ===== */
  const sum = (field,s,e)=>
    pps.reduce((a,r)=>{
      const d=new Date(r.date+"T00:00:00");
      return (d.getMonth()+1===M && d.getDate()>=s && d.getDate()<=e)
        ? a+num(r[field]) : a;
    },0);

  /* ===== ACTUAL ===== */
  const PSM = [
    sum("PSM",1,7),
    sum("PSM",8,15),
    sum("PSM",16,23),
    sum("PSM",24,eom)
  ];

  const PWP = [
    sum("PWP",1,15),
    sum("PWP",16,eom)
  ];

  const SG = [
    sum("SERBA GRATIS",1,15),
    sum("SERBA GRATIS",16,eom)
  ];

  /* ===== TARGET ===== */
  const tp = cfg.targetPeriod || {};
  const tPSM = tp.PSM || {};
  const tPWP = tp.PWP || {};
  const tSG  = tp["SERBA GRATIS"] || {};

  const psmTarget = num(tPSM.W1)+num(tPSM.W2)+num(tPSM.W3)+num(tPSM.W4);
  const pwpTarget = num(tPWP.W1)+num(tPWP.W2);
  const sgTarget  = num(tSG.W1)+num(tSG.W2);

  const psmActual = PSM.reduce((a,b)=>a+b,0);
  const pwpActual = PWP.reduce((a,b)=>a+b,0);
  const sgActual  = SG.reduce((a,b)=>a+b,0);

  /* ===== TRACKER ===== */
  renderTracker("psmTracker",[
    {label:"PSM W1",range:"(1-7)", actual:PSM[0], target:num(tPSM.W1)},
    {label:"PSM W2",range:"(8-15)",actual:PSM[1], target:num(tPSM.W2)},
    {label:"PSM W3",range:"(16-23)",actual:PSM[2], target:num(tPSM.W3)},
    {label:"PSM W4",range:`(24-${eom})`,actual:PSM[3], target:num(tPSM.W4)}
  ]);

  renderTracker("pwpTracker",[
    {label:"PWP W1",range:"(1-15)", actual:PWP[0], target:num(tPWP.W1)},
    {label:"PWP W2",range:`(16-${eom})`, actual:PWP[1], target:num(tPWP.W2)}
  ]);

  renderTracker("sgTracker",[
    {label:"SG W1",range:"(1-15)", actual:SG[0], target:num(tSG.W1)},
    {label:"SG W2",range:`(16-${eom})`, actual:SG[1], target:num(tSG.W2)}
  ]);

  /* ===== PPS SCORE ===== */
  const W = cfg.ppsWeight || {APC:.25,PSM:.2,PWP:.25,"SERBA GRATIS":.3};

  const score =
    clamp(apcAch) * num(W.APC) +
    clamp(psmActual/psmTarget||0) * num(W.PSM) +
    clamp(pwpActual/pwpTarget||0) * num(W.PWP) +
    clamp(sgActual/sgTarget||0)   * num(W["SERBA GRATIS"]);

  cardPpsScore.textContent = pct(score);
  const st = status(score);
  cardPpsStatus.textContent = st.t;
  cardPpsStatus.className = "badge "+st.c;
  setBar("barPps", score);

  /* ===== GAP ===== */
  gapSales.textContent = rupiah(cfg.targetNetSales-actualSales);
  gapPsm.textContent   = psmTarget-psmActual;
  gapPwp.textContent   = pwpTarget-pwpActual;
  gapSg.textContent    = sgTarget-sgActual;
}
</script>
